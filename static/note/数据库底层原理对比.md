# 数据库底层原理对比

MySQL (InnoDB)、PostgreSQL 和 Oracle 三大数据库在 INSERT、UPDATE、DELETE、SELECT、TRUNCATE 操作以及 MVCC 实现机制上的完整对比。


## 一、基本操作的底层逻辑对比

| 操作     | MySQL (InnoDB)                                                                 | PostgreSQL                                                                               | Oracle                                                                     |
|----------|--------------------------------------------------------------------------------|------------------------------------------------------------------------------------------|----------------------------------------------------------------------------|
| INSERT   | - 插入聚集索引<br>- 添加 DB_TRX_ID、DB_ROLL_PTR 隐藏列<br>- 更新二级索引       | - 插入堆表（heap）<br>- 设置 xmin（插入事务ID）<br>- 更新所有索引                        | - 插入数据块，生成 Rowid<br>- 记录 Undo Entry<br>- 更新所有索引            |
| UPDATE   | - 标记删除旧行 + 插入新行<br>- DB_ROLL_PTR 指向 undo log<br>- 所有索引必须更新 | - 设置 xmax = 当前事务ID<br>- 插入新行，xmin = 当前事务ID<br>- 可能使用 HOT 避免索引更新 | - 原地更新或插入新行（行迁移）<br>- 生成 Undo 记录<br>- 所有索引必须更新   |
| DELETE   | - 标记删除，设置 DB_TRX_ID<br>- Purge 线程异步物理删除                         | - 设置 xmax = 当前事务ID<br>- VACUUM 清理 dead tuple                                     | - 行头标记为“已删除”<br>- 生成 Undo 记录<br>- 提交后由 SMON 清理           |
| SELECT   | - 快照读，基于 Read View<br>- 遍历 DB_ROLL_PTR + Undo 构建历史版本             | - 快照读，基于 xmin/xmax 与事务快照判断可见性<br>- 版本在表中直接访问                    | - 基于 SCN 构建一致性读<br>- 使用 Undo 构造 CR 块（Consistent Read Block） |
| TRUNCATE | - DDL，重建表<br>- 不可回滚<br>- 重置 auto_increment                           | - DDL，删除数据页<br>- 可在事务中回滚<br>- 不触发行级触发器                              | - DDL，高速清空<br>- 默认不可回滚<br>- 可触发 DDL 触发器                   |


## 二、MVCC 实现机制对比

| 维度            | MySQL (InnoDB)                                  | PostgreSQL                                      | Oracle                                         |
|-----------------|-------------------------------------------------|-------------------------------------------------|------------------------------------------------|
| MVCC 核心机制   | Undo Log + Read View + 事务ID                   | xmin/xmax + 事务快照（Snapshot）                | SCN + Undo Segment + CR（一致性读）            |
| 版本存储位置    | Undo Log（回滚段）                              | 表和索引中（堆内多版本）                        | Undo Tablespace（独立回滚空间）                |
| 版本链结构      | DB_ROLL_PTR 指向 undo 中旧版本（单向链表）      | ctid 链接物理位置                               | Undo Block 中的前向指针链接                    |
| 可见性判断依据  | DB_TRX_ID vs Read View（m_ids, min/max trx_id） | xmin/xmax vs 当前事务快照                       | 行的 SCN vs 当前事务 SCN                       |
| 一致性读实现    | Read View 构建事务级快照                        | SnapshotData                                    | 构建快照	SCN 时间点快照，通过 Undo 回溯         |
| 垃圾回收（GC）  | Purge 线程异步清理                              | VACUUM（手动或 autovacuum）清理 dead tuple      | SMON 进程清理过期 undo，空间可重用             |
| 事务ID / 时间戳 | 48位递增事务ID                                  | 32位事务ID（循环使用，需防 wraparound）         | SCN（System Change Number，逻辑时间戳）        |
| 隔离级别支持    | - RC, RR（默认）<br>- RR 模拟串行化             | - RC, RR, Serializable（SSI）<br>- SSI 避免写偏 | - RC, Serializable（快照隔离）<br>- 非真正 SSI |
| 回滚段管理      | 系统表空间或独立 undo tablespace                | 无独立回滚段，版本在表中                        | Undo Tablespace，可配置 UNDO_RETENTION         |


## 三、关键特性对比总结

| 特性                  | MySQL (InnoDB)        | PostgreSQL           | Oracle                |
|-----------------------|-----------------------|----------------------|-----------------------|
| MVCC 存储位置         | Undo Log              | 表内（堆）           | Undo Tablespace       |
| 版本链构建方式        | DB_ROLL_PTR → Undo    | ctid → 物理行        | Undo Block 链         |
| 快照单位              | 事务级 Read View      | 事务级 Snapshot      | SCN 时间点快照        |
| UPDATE 是否更新索引   | 是（全部）            | 可能否（HOT 优化）   | 是（全部）            |
| 空间回收机制          | Purge 线程            | VACUUM / autovacuum  | SMON + Undo Retention |
| TRUNCATE 可回滚       | 否                    | 是                   | 默认否（可配置）      |
| 长事务主要风险        | undo 膨胀，Purge 滞后 | 表膨胀（bloat）      | ORA-01555（快照过旧） |
| 真正的可串行化（SSI） | 否                    | 是                   | 否                    |
| 高水位线（HWM）       | 有（不自动收缩）      | 有（需 VACUUM FULL） | 有（需 shrink/move）  |
| 逻辑时间戳            | 事务ID                | 事务ID               | SCN                   |


## 四、典型问题与运维建议

| 数据库     | 典型问题                                   | 运维建议                                                             |
|------------|--------------------------------------------|----------------------------------------------------------------------|
| MySQL      | - undo 表空间膨胀<br>- Purge 滞后          | - 避免长事务<br>- 启用 innodb_undo_log_truncate<br>- 监控 purge 状态 |
| PostgreSQL | - 表/索引膨胀（bloat）<br>- XID wraparound | - 启用 autovacuum<br>- 定期 VACUUM FULL<br>- 监控 datfrozenxid       |
| Oracle     | - ORA-01555<br>- Undo 空间不足<br>- 行迁移 | - 设置合理 UNDO_RETENTION<br>- 监控 undo 表空间<br>- 使用 ASSM       |


## 五、选型建议

| 场景                           | 推荐数据库          | 说明                                           |
|--------------------------------|---------------------|------------------------------------------------|
| 高并发 OLTP，Web 应用         | MySQL               | 成熟、轻量、社区广泛                           |
| 复杂查询、分析型负载           | PostgreSQL / Oracle | PG 开源功能强，Oracle 企业级稳定               |
| 需要可回滚的 TRUNCATE          | PostgreSQL          | 唯一支持事务内回滚 TRUNCATE                    |
| 需要真正的可串行化（避免写偏） | PostgreSQL          | 唯一实现 Serializable Snapshot Isolation (SSI) |
| 企业级高可用、RAC 集群         | Oracle              | RAC、Data Guard 等成熟方案                     |
| 成本敏感，功能丰富             | PostgreSQL          | 功能最接近 Oracle 的开源数据库                 |
| 精细控制一致性读保留时间       | Oracle              | UNDO_RETENTION 可精确配置                      |
